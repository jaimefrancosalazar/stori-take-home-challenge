version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@9.3.3
  aws-ecs: circleci/aws-ecs@4.0.0
  aws-cli: circleci/aws-cli@5.4.1

jobs:
  build-and-push:
    docker:
      - image: cimg/aws:2024.03
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Verify AWS credentials are available
          command: |
            if [ -z "$AWS_ACCESS_KEY_ID" ]; then
              echo "ERROR: AWS_ACCESS_KEY_ID is not set"
              exit 1
            fi
            if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
              echo "ERROR: AWS_SECRET_ACCESS_KEY is not set"
              exit 1
            fi
            echo "AWS credentials are available"
            echo "AWS_ACCESS_KEY_ID starts with: ${AWS_ACCESS_KEY_ID:0:4}..."
      - run:
          name: Login to ECR
          command: |
            export AWS_DEFAULT_REGION=us-east-2
            aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 809893975291.dkr.ecr.us-east-2.amazonaws.com
      - run:
          name: Build Docker image
          command: |
            cd application
            docker build -t 809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:${CIRCLE_SHA1} .
            docker tag 809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:${CIRCLE_SHA1} 809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:latest
      - run:
          name: Push to ECR
          command: |
            docker push 809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:${CIRCLE_SHA1}
            docker push 809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:latest

  deploy-to-ecs:
    docker:
      - image: cimg/aws:2024.03
    steps:
      - run:
          name: Update ECS service
          command: |
            export AWS_DEFAULT_REGION=us-east-2

            # Get current task definition
            TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition stori-challenge --region us-east-2)

            # Create new task definition with updated image
            NEW_TASK_DEF=$(echo $TASK_DEFINITION | jq --arg IMAGE "809893975291.dkr.ecr.us-east-2.amazonaws.com/stori-challenge-app:${CIRCLE_SHA1}" \
              '.taskDefinition | .containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

            # Register new task definition
            NEW_TASK_INFO=$(aws ecs register-task-definition --region us-east-2 --cli-input-json "$NEW_TASK_DEF")
            NEW_REVISION=$(echo $NEW_TASK_INFO | jq -r '.taskDefinition.revision')

            echo "Registered new task definition revision: $NEW_REVISION"

            # Update service to use new task definition
            aws ecs update-service \
              --cluster stori-challenge-cluster \
              --service stori-challenge-service \
              --task-definition stori-challenge:${NEW_REVISION} \
              --region us-east-2

            echo "Service updated successfully"

workflows:
  build-and-deploy:
    jobs:
      # Build and push Docker image to ECR when code changes in application/
      - build-and-push:
          name: build-and-push-image
          context: aws-access
          filters:
            branches:
              only:
                - main

      # Deploy new task definition to ECS
      - deploy-to-ecs:
          name: deploy-to-ecs
          context: aws-access
          requires:
            - build-and-push-image
          filters:
            branches:
              only:
                - main
